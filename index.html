<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Music player</title>
    <link rel="stylesheet" href="./style.css">
  </head>
  <body>
    <div class="auth">
      <div>
        <button id="auth">Connect Wallet</button>
        <div class="wa">
          <span>My address: </span>
          <span id="addr"></span>
        </div>
      </div>
      <div>
        <button id="opn-btn">Open Payment Channel</button>
        <div class="ca">
          <span>Channel Address: </span>
          <span id="chAddr"></span>
        </div>
        <div class="ba">
          <span>Balance A (User): </span>
          <span id="ba"></span>
        </div>
        <div class="bb">
          <span>Balance B (Influencer): </span>
          <span id="bb"></span>
        </div>
        <button id="cls-btn">Close Payment Channel</button>
      </div>
    </div>
    <div class="body">
      <div class="player">
        <div class="player__header">
          <div class="player__img player__img--absolute slider">
            <button class="player__button player__button--absolute--nw playlist">
              <img src="http://physical-authority.surge.sh/imgs/icon/playlist.svg" alt="playlist-icon">
            </button>
            <button class="player__button player__button--absolute--center play">
              <img src="http://physical-authority.surge.sh/imgs/icon/play.svg" alt="play-icon">
              <img src="http://physical-authority.surge.sh/imgs/icon/pause.svg" alt="pause-icon">
            </button>
            <div class="slider__content">
              <img class="img slider__img" src="http://physical-authority.surge.sh/imgs/1.jpg" alt="cover">
              <img class="img slider__img" src="http://physical-authority.surge.sh/imgs/2.jpg" alt="cover">
              <img class="img slider__img" src="http://physical-authority.surge.sh/imgs/3.jpg" alt="cover">
              <img class="img slider__img" src="http://physical-authority.surge.sh/imgs/4.jpg" alt="cover">
              <img class="img slider__img" src="http://physical-authority.surge.sh/imgs/5.jpg" alt="cover">
              <img class="img slider__img" src="http://physical-authority.surge.sh/imgs/6.jpg" alt="cover">
              <img class="img slider__img" src="http://physical-authority.surge.sh/imgs/7.jpg" alt="cover">
            </div>
          </div>
          <div class="player__controls">
            <button class="player__button back">
              <img class="img" src="http://physical-authority.surge.sh/imgs/icon/back.svg" alt="back-icon">
            </button>
            <p class="player__context slider__context">
              <strong class="slider__name"></strong>
              <span class="player__title slider__title"></span>
            </p>
            <button class="player__button next">
              <img class="img" src="http://physical-authority.surge.sh/imgs/icon/next.svg" alt="next-icon">
            </button>
            <div class="progres">
              <div class="progres__filled"></div>
            </div>
          </div>
        </div>
        <ul class="player__playlist list">
          <li class="player__song">
            <img class="player__img img" src="http://physical-authority.surge.sh/imgs/1.jpg" alt="cover">
            <p class="player__context">
              <b class="player__song-name">no time</b>
              <span class="flex">
                <span class="player__title">lastlings</span>
                <span class="player__song-time"></span>
              </span>
            </p>
            <audio class="audio" src="http://physical-authority.surge.sh/music/1.mp3"></audio>
          </li>
          <li class="player__song">
            <img class="player__img img" src="http://physical-authority.surge.sh/imgs/2.jpg" alt="cover">
            <p class="player__context">
              <b class="player__song-name">blinding lights</b>
              <span class="flex">
                <span class="player__title">the weeknd</span>
                <span class="player__song-time"></span>
              </span>
            </p>
            <audio class="audio" src="http://physical-authority.surge.sh/music/2.mp3"></audio>
          </li>
          <li class="player__song">
            <img class="player__img img" src="http://physical-authority.surge.sh/imgs/3.jpg" alt="cover">
            <p class="player__context">
              <b class="player__song-name">джованна</b>
              <span class="flex">
                <span class="player__title">enrasta</span>
                <span class="player__song-time"></span>
              </span>
            </p>
            <audio class="audio" src="http://physical-authority.surge.sh/music/3.mp3"></audio>
          </li>
          <li class="player__song">
            <img class="player__img img" src="http://physical-authority.surge.sh/imgs/4.jpg" alt="cover">
            <p class="player__context">
              <b class="player__song-name">a man</b>
              <span class="flex">
                <span class="player__title">travis scott</span>
                <span class="player__song-time"></span>
              </span>
            </p>
            <audio class="audio" src="http://physical-authority.surge.sh/music/4.mp3"></audio>
          </li>
          <li class="player__song">
            <img class="player__img img" src="http://physical-authority.surge.sh/imgs/5.jpg" alt="cover">
            <p class="player__context ">
              <b class="player__song-name">unforgetting</b>
              <span class="flex">
                <span class="player__title">zaxx</span>
                <span class="player__song-time"></span>
              </span>
            </p>
            <audio class="audio" src="http://physical-authority.surge.sh/music/5.mp3"></audio>
          </li>
          <li class="player__song">
            <img class="player__img img" src="http://physical-authority.surge.sh/imgs/6.jpg" alt="cover">
            <p class="player__context">
              <b class="player__song-name">waharan</b>
              <span class="flex">
                <span class="player__title">Randall</span>
                <span class="player__song-time"></span>
              </span>
            </p>
            <audio class="audio" src="http://physical-authority.surge.sh/music/6.mp3"></audio>
          </li>
          <li class="player__song">
            <img class="player__img img" src="http://physical-authority.surge.sh/imgs/7.jpg" alt="cover">
            <p class="player__context ">
              <b class="player__song-name">starlight feat mr gabriel <span class="uppercase">4am</span> remix</b>
              <span class="flex">
                <span class="player__title">jai wolf</span>
                <span class="player__song-time"></span>
              </span>
            </p>
            <audio class="audio" src="http://physical-authority.surge.sh/music/7.mp3"></audio>
          </li>
        </ul>
      </div>
    </div>
    <script type="text/javascript" src="./libs/tonweb.js"></script>
    <script>
      let a = 0, b = 0, c = 0;
      const tonweb = new window.TonWeb(new window.TonWeb.HttpProvider('https://testnet.toncenter.com/api/v2/jsonRPC', {apiKey: '8c9f4155363c542e4fe538f9e5eb101577b2b41e6ba3cd252fdbf5d1f9187fef'}));
      const BN = window.TonWeb.utils.BN;
      const toNano = window.TonWeb.utils.toNano;
      
      const onTonReady = async () => {
        console.log('tonready');

        if (!window.tonProtocolVersion || window.tonProtocolVersion < 1) {
          alert('Please update your TON Wallet Extension');
          return;
        };
        
        const provider = window.ton;
        console.log('isTonWallet =', provider.isTonWallet);
        
        const connect = async () => {
          const accounts = await provider.send('ton_requestAccounts');
          const account = accounts[0];
          showAccountAddress(account);
          console.log(await provider.send('ton_requestWallets'));
        };

        document.getElementById('auth').addEventListener('click', async () => {
          try {
            await connect();
          } catch (e) {
            console.error(e);
          };
        });
        
        provider.on('accountsChanged', function (accounts) {
          console.log('accountsChanged', accounts);
          const account = accounts[0];
          showAccountAddress(account);
        });
        
        function showAccountAddress(address) {
          document.getElementById('addr').innerText = address;
        };
      };

      const init = async () => {
        const seedA = await window.TonWeb.utils.hexToBytes('0ad96df89d017c55a11c191d33902917c3146136511824aee7b853dbc6b851bf');
        const keyPairA = tonweb.utils.keyPairFromSeed(seedA);

        const seedB = await window.TonWeb.utils.hexToBytes('33e6b46968bf3704a08ddd377d43862e08a6c1114c570da2f024184faa2e6b17');
        const keyPairB = tonweb.utils.keyPairFromSeed(seedB);
        
        const walletA = tonweb.wallet.create({
          publicKey: keyPairA.publicKey
        });
        const walletAddressA = await walletA.getAddress();
        console.log('walletAddressA =', walletAddressA.toString(true, true, true));
        
        const walletB = tonweb.wallet.create({
          publicKey: keyPairB.publicKey
        });
        const walletAddressB = await walletB.getAddress();
        console.log('walletAddressB =', walletAddressB.toString(true, true, true));
        
        const channelInitState = {
          balanceA: toNano('1'),
          balanceB: toNano('1'),
          seqnoA: new BN(0),
          seqnoB: new BN(0)
        };
        
        const channelConfig = {
          channelId: new BN(124),
          addressA: walletAddressA,
          addressB: walletAddressB,
          initBalanceA: channelInitState.balanceA,
          initBalanceB: channelInitState.balanceB
        };
        
        const channelA = tonweb.payments.createChannel({
          ...channelConfig,
          isA: true,
          myKeyPair: keyPairA,
          hisPublicKey: keyPairB.publicKey
        });
        const channelAddress = await channelA.getAddress();
        document.getElementById('chAddr').innerText = channelAddress.toString(true, true, true);
        console.log('channelAddress =', channelAddress.toString(true, true, true));
        
        const channelB = tonweb.payments.createChannel({
          ...channelConfig,
          isA: false,
          myKeyPair: keyPairB,
          hisPublicKey: keyPairA.publicKey
        });
        
        if ((await channelB.getAddress()).toString() !== channelAddress.toString()) {
          throw new Error('Channels address not same');
        };
        
        const fromWalletA = channelA.fromWallet({
          wallet: walletA,
          secretKey: keyPairA.secretKey
        });
        
        const fromWalletB = channelB.fromWallet({
          wallet: walletB,
          secretKey: keyPairB.secretKey
        });

        document.getElementById('opn-btn').addEventListener('click', async () => {
          await fromWalletB.deploy().send(toNano('0.05'));
        
          console.log(await channelB.getChannelState());
          setInterval(async () => {
            const data = await channelB.getData();
            document.getElementById('ba').innerText = data.balanceA.toString();
            document.getElementById('bb').innerText = data.balanceB.toString();
          }, 2000);
          const data = await channelB.getData();
          console.log('balanceA = ', data.balanceA.toString());
          console.log('balanceB = ', data.balanceB.toString());

          new Promise(async (resolve, reject) => {
            await fromWalletA.topUp({coinsA: channelInitState.balanceA, coinsB: new BN(0)}).send(channelInitState.balanceA.add(toNano('0.05')));
            await fromWalletB.topUp({coinsA: new BN(0), coinsB: channelInitState.balanceB}).send(channelInitState.balanceB.add(toNano('0.05')));
            setTimeout(async () => {
              console.log('5 sec');
            }, 5000);
          }).then(async () => {
            await fromWalletB.init(channelInitState).send(toNano('0.05'));
          });
        });
      
        const channelState = {
          balanceA: toNano('0.99'),
          balanceB: toNano('1.01'),
          seqnoA: new BN(1),
          seqnoB: new BN(0)
        };
        
        const signatureA = await channelA.signState(channelState);
        
        if (!(await channelB.verifyState(channelState, signatureA))) {
          throw new Error('Invalid A signature');
        };
        const signatureB = await channelB.signState(channelState);

        document.getElementById('cls-btn').addEventListener('click', async () => {
          try {
            const signatureCloseA = await channelB.signClose(channelState);
            
            if (!(await channelB.verifyClose(channelState, signatureCloseA))) {
              throw new Error('Invalid B signature');
            };
            
            await fromWalletA.close({
              ...channelState,
              hisSignature: signatureCloseA
            }).send(toNano('0.05'));
          } catch (e) {
            console.error(e);
          };
        });
      };

      if (window.ton) {
        onTonReady();
        init();
      } else {
        window.addEventListener('tonready', () => onTonReady(), false);
      };
    </script>
    <script src="./script.js"></script>
  </body>
</html>
